<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/alpinejs-logo-icon.svg" />
    <link rel="stylesheet" href="/common/styles.css" />
    <title>Alpine TODO</title>
  </head>
  <body>
    <h1>Alpine.js TODO</h1>

    <a class="switch-link" id="open-react" href="#">React version</a>

    <!-- フィルタ状態はこの root のローカル state に持たせる -->
    <div x-data="{ filter: 'all' }" x-init="$store.todos.load()">
      <div class="input-row" x-data="{ draft: '' }">
        <input
          type="text"
          placeholder="新しいTODOを入力して Enter"
          x-model="draft"
          @keyup.enter="if(draft && draft.trim()){ $store.todos.add(draft.trim()); draft = '' }"
        />
        <button
          class="input-button"
          @click="if(draft && draft.trim()){ $store.todos.add(draft.trim()); draft = '' }"
        >
          追加
        </button>
      </div>

      <!-- フィルタ -->
      <div class="controls">
        <div class="small">
          表示:
          <button
            x-bind:class="{ 'font-weight-bold': filter === 'all' }"
            @click="filter = 'all'"
          >
            All
          </button>
          <button
            :class="{ 'font-weight-bold': filter === 'active' }"
            @click="filter = 'active'"
          >
            Active
          </button>
          <button
            :class="{ 'font-weight-bold': filter === 'completed' }"
            @click="filter = 'completed'"
          >
            Completed
          </button>
        </div>
        <div style="margin-left: auto">
          <button
            class="clear-completed"
            @click="$store.todos.clearCompleted()"
          >
            Clear completed
          </button>
        </div>
      </div>

      <div style="margin-top: 1rem">
        <template
          x-for="todo in $store.todos.list.filter(t => filter === 'all' || (filter === 'active' && !t.completed) || (filter === 'completed' && t.completed))"
          :key="todo.id"
        >
          <div class="todo" x-data="todoItem(todo)">
            <input
              type="checkbox"
              :checked="todo.completed"
              @change="$store.todos.setCompleted(todo.id, $event.target.checked)"
            />
            <div class="text">
              <template x-if="!editing">
                <div>
                  <span
                    x-text="todo.text"
                    :class="{ 'completed': todo.completed }"
                  ></span>
                </div>
              </template>

              <template x-if="editing">
                <div style="display: flex; gap: 0.5rem">
                  <input
                    x-ref="input"
                    type="text"
                    x-model="tempText"
                    @keyup.enter="save()"
                    @keyup.escape="cancel()"
                  />
                  <button @click="save()">Save</button>
                  <button @click="cancel()">Cancel</button>
                </div>
              </template>
            </div>

            <button @click="startEdit()">Edit</button>
            <button @click="$store.todos.remove(todo.id)">Delete</button>
          </div>
        </template>

        <div
          x-show="$store.todos.list.length === 0"
          class="small"
          style="margin-top: 0.5rem"
        >
          TODO は空です
        </div>
      </div>
    </div>
    <script>
      // 切替ボタン挙動：localStorage にフレームワークを記録してルートに遷移
      document
        .getElementById("open-react")
        ?.addEventListener("click", function (ev) {
          ev.preventDefault();
          try {
            localStorage.setItem("ui_framework", "react");
          } catch (e) {
            /* ignore */
          }
          // Reactのページへ
          location.href = "/react.html";
        });
    </script>

    <script type="module" src="/alpine/main.ts"></script>
  </body>
</html>
